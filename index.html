<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>IoT Road HUD — Responsive Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#050812;
      --bg1:#0a1226;
      --glass: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);

      --txt:#eaf7ff;
      --muted:#b8d0e6;

      --cyan:#38f6ff;
      --blue:#67bfff;
      --green:#49ffb2;
      --yellow:#ffe47a;
      --orange:#ffb566;
      --red:#ff5f7a;

      --shadow: 0 26px 70px rgba(0,0,0,.72);
      --inset: inset 0 0 0 1px rgba(0,0,0,.40);

      --gap: 14px;
      --pad: 14px;

      --colRight: clamp(360px, 28vw, 470px);
      --rowBottom: clamp(240px, 28vh, 310px);

      --btnH: 44px;
      --btnR: 14px;
      --btnShadow: 0 10px 0 rgba(0,0,0,.45), 0 18px 34px rgba(0,0,0,.62);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(980px 640px at 26% 12%, rgba(56,246,255,.18), transparent 56%),
        radial-gradient(860px 560px at 86% 56%, rgba(255,95,122,.14), transparent 58%),
        radial-gradient(780px 520px at 18% 86%, rgba(73,255,178,.10), transparent 62%),
        linear-gradient(180deg, #02030a, var(--bg0));
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
    }

    .wrap{
      width:min(1400px, 96vw);
      height:min(860px, 92vh);
      position:relative;
    }

    .bezel{
      position:absolute; inset:0;
      border-radius:26px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.028));
      border:1px solid rgba(255,255,255,.20);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .bezel::before{
      content:"";
      position:absolute; inset:-34px;
      background:
        radial-gradient(980px 260px at 50% 0%, rgba(103,191,255,.30), transparent 66%),
        linear-gradient(90deg, rgba(255,181,102,.20), transparent 34%, transparent 66%, rgba(255,181,102,.20));
      filter: blur(16px);
      opacity:.78;
      pointer-events:none;
    }

    .hud{
      position:absolute;
      inset:16px;
      border-radius:20px;
      background: linear-gradient(180deg, rgba(12,18,34,.95), rgba(6,8,16,.96));
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .header{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .headerInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }
    .title{
      flex:1;
      text-align:center;
      font-weight:950;
      font-size: clamp(22px, 2.0vw, 34px);
      letter-spacing:.7px;
      text-shadow: 0 0 18px rgba(56,246,255,.16);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .headerActions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-shrink:0;
      flex-wrap:wrap;
      justify-content:center;
    }

    .btn3d{
      height:var(--btnH);
      border:none;
      cursor:pointer;
      user-select:none;
      padding:0 16px;
      border-radius: var(--btnR);
      font-weight:950;
      letter-spacing:.9px;
      text-transform:uppercase;
      color: rgba(236,253,255,.98);
      background:
        radial-gradient(120% 120% at 30% 15%, rgba(255,255,255,.32), transparent 46%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.03) 55%, rgba(0,0,0,.34)),
        linear-gradient(90deg, rgba(56,246,255,.18), transparent 35%, transparent 65%, rgba(255,95,122,.12));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:
        var(--btnShadow),
        0 0 26px rgba(56,246,255,.10),
        var(--inset);
      position:relative;
      transform: translateY(0);
      transition: transform .06s ease, filter .15s ease, box-shadow .15s ease;
      min-width: 160px;
    }
    .btn3d::before{
      content:"";
      position:absolute; inset:0;
      border-radius: inherit;
      border: 1px solid rgba(56,246,255,.24);
      box-shadow: inset 0 0 18px rgba(56,246,255,.10);
      pointer-events:none;
    }
    .btn3d:active{
      transform: translateY(7px);
      box-shadow: 0 2px 0 rgba(0,0,0,.45), 0 10px 16px rgba(0,0,0,.62), var(--inset);
    }

    .btnReset{
      min-width: 140px;
      background:
        radial-gradient(120% 120% at 30% 15%, rgba(255,255,255,.22), transparent 46%),
        linear-gradient(180deg, rgba(255,181,102,.22), rgba(0,0,0,.36));
      border: 1px solid rgba(255,181,102,.34);
      box-shadow: var(--btnShadow), 0 0 26px rgba(255,181,102,.14), var(--inset);
    }
    .btnReset::before{
      border-color: rgba(255,181,102,.40);
      box-shadow: inset 0 0 18px rgba(255,181,102,.12);
    }

    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      font-weight:950;
      text-transform:uppercase;
      letter-spacing:.8px;
      min-width: 190px;
      justify-content:center;
      box-shadow: 0 14px 26px rgba(0,0,0,.40), var(--inset);
      backdrop-filter: blur(6px);
      height: var(--btnH);
    }
    .pill .dot{ width:16px; height:16px; border-radius:50%; }
    .pill.connected{
      color: rgba(73,255,178,.98);
      border-color: rgba(73,255,178,.32);
      background: rgba(73,255,178,.08);
    }
    .pill.connected .dot{ background: var(--green); box-shadow: 0 0 16px rgba(73,255,178,.95); }
    .pill.disconnected{
      color: rgba(255,95,122,.98);
      border-color: rgba(255,95,122,.32);
      background: rgba(255,95,122,.08);
    }
    .pill.disconnected .dot{ background: var(--red); box-shadow: 0 0 16px rgba(255,95,122,.95); }

    .main{
      flex:1;
      display:grid;
      grid-template-columns: 1fr 1fr var(--colRight);
      grid-template-rows: 1fr var(--rowBottom);
      gap: var(--gap);
      padding: var(--pad);
      min-height:0;
      overflow:hidden;
    }

    .card{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 360px at 40% 10%, rgba(56,246,255,.10), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.045), rgba(0,0,0,.16));
      box-shadow: 0 18px 40px rgba(0,0,0,.46), var(--inset);
      overflow:hidden;
      min-height:0;
      position:relative;
    }
    .cardBody{ padding:12px; min-height:0; height:100%; }

    .chartCard{
      grid-column: 1 / 3;
      grid-row: 1 / 2;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .cardHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(56,246,255,.22);
      font-weight:950;
      letter-spacing:2.2px;
      text-transform:uppercase;
      font-size:26px;
      color: rgba(236,253,255,.98);
      background: linear-gradient(180deg, rgba(56,246,255,.10), rgba(255,255,255,.03));
      text-shadow: 0 0 22px rgba(56,246,255,.24);
      position:relative;
    }
    .cardHeader::after{
      content:"";
      position:absolute; left:16px; right:16px; bottom:8px;
      height:2px; border-radius:2px;
      background: linear-gradient(90deg, rgba(56,246,255,.88), rgba(73,255,178,.55), rgba(255,95,122,.55));
      opacity:.95;
    }

    .chartCard .cardBody{ flex:1; display:flex; min-height:0; }
    .chartArea{
      flex:1; min-height:0;
      position:relative;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: var(--inset);
      overflow:hidden;
      padding:14px;
      padding-top:60px;
    }
    .chartArea::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 320px at 30% 18%, rgba(73,255,178,.12), transparent 68%),
        radial-gradient(1000px 360px at 72% 86%, rgba(255,95,122,.12), transparent 70%);
      pointer-events:none;
      opacity:.95;
      z-index:0;
    }
    canvas#roadChart{
      width:100% !important;
      height:100% !important;
      display:block;
      position:relative;
      z-index:1;
    }

    .legend{
      position:absolute;
      top:12px; left:12px; right:12px;
      display:flex;
      justify-content:center;
      gap:10px;
      pointer-events:none;
      z-index:3;
    }
    .badge{
      display:flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      font-weight:950;
      letter-spacing:.8px;
      text-transform:uppercase;
      font-size:12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.35), var(--inset);
      backdrop-filter: blur(6px);
    }
    .badge .c{ width:10px; height:10px; border-radius:50%; }
    .bN .c{ background: var(--green); box-shadow: 0 0 14px rgba(73,255,178,.95); }
    .bT .c{ background: var(--blue);  box-shadow: 0 0 14px rgba(103,191,255,.95); }
    .bH .c{ background: var(--red);   box-shadow: 0 0 14px rgba(255,95,122,.95); }

    .telemetryCard{ grid-column: 1 / 3; grid-row: 2 / 3; }
    .telemetry{
      height:100%;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-content:start;
    }
    .telemetry .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      box-shadow: var(--inset);
      min-height:60px;
    }
    .telemetry .k{
      color: var(--muted);
      font-weight:950;
      font-style:italic;
      font-size:18px;
      white-space:nowrap;
    }
    .telemetry .v{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-weight:950;
      color:#f0fcff;
      font-size:18px;
      text-align:right;
    }
    .telemetry .big{
      font-size:44px;
      color: var(--orange);
      text-shadow: 0 0 22px rgba(255,181,102,.24);
      letter-spacing:1px;
    }
    .telemetry .span2{ grid-column: 1 / 3; }

    .rightPanel{
      grid-column: 3 / 4;
      grid-row: 1 / 3;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .panelBox{
      height:100%;
      min-height:0;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 420px at 45% 10%, rgba(56,246,255,.12), transparent 62%),
        rgba(0,0,0,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.40), var(--inset);
      padding:14px;
      position:relative;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .lampsBox{
      position:relative;
      z-index:1;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      box-shadow: 0 14px 26px rgba(0,0,0,.35), var(--inset);
      padding:14px;
      flex:0 0 auto;
    }
    .lampsGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:14px;
      align-items:center;
      justify-items:center;
    }
    .lamp{
      width:170px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:10px;
    }
    .bulb{
      width:82px; height:82px;
      border-radius:50%;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.15);
      box-shadow: inset 0 0 18px rgba(0,0,0,.55), 0 12px 22px rgba(0,0,0,.35);
      position:relative;
    }
    .bulb::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.72), rgba(255,255,255,.12) 55%, transparent 70%);
      opacity:.45;
    }
    .lampLabel{
      font-weight:950;
      letter-spacing:.9px;
      text-transform:uppercase;
      font-size:20px;
    }

    .lamp.green .lampLabel{ color: rgba(73,255,178,.98); }
    .lamp.red .lampLabel{ color: rgba(255,95,122,.98); }
    .lamp.yellow .lampLabel{ color: rgba(255,228,122,.98); }
    .lamp.blue .lampLabel{ color: rgba(103,191,255,.98); }

    .on.green .bulb{
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.72), rgba(73,255,178,.42) 40%, rgba(73,255,178,.14));
      box-shadow: 0 0 44px rgba(73,255,178,.98), inset 0 0 16px rgba(0,0,0,.45);
    }
    .on.red .bulb{
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.72), rgba(255,95,122,.42) 40%, rgba(255,95,122,.14));
      box-shadow: 0 0 44px rgba(255,95,122,.98), inset 0 0 16px rgba(0,0,0,.45);
    }
    .on.yellow .bulb{
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.72), rgba(255,228,122,.42) 40%, rgba(255,228,122,.14));
      box-shadow: 0 0 44px rgba(255,228,122,.98), inset 0 0 16px rgba(0,0,0,.45);
    }
    .on.blue .bulb{
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.72), rgba(103,191,255,.42) 40%, rgba(103,191,255,.14));
      box-shadow: 0 0 44px rgba(103,191,255,.98), inset 0 0 16px rgba(0,0,0,.45);
    }

    .controlsBox{
      position:relative;
      z-index:1;
      flex:1;
      min-height:0;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      box-shadow: var(--inset);
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .dpad{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap:12px;
      margin-top:auto;
    }
    .ghost{ opacity:0; pointer-events:none; }

    .btnSmall{ min-width:auto; height:44px; padding:0 12px; font-size:13px; border-radius:13px; }
    .btnStop{
      color: rgba(255,236,240,.98);
      background:
        radial-gradient(120% 120% at 30% 15%, rgba(255,255,255,.24), transparent 46%),
        linear-gradient(180deg, rgba(255,95,122,.24), rgba(0,0,0,.36));
      border: 1px solid rgba(255,95,122,.34);
      box-shadow: var(--btnShadow), 0 0 28px rgba(255,95,122,.16), var(--inset);
    }
    .btnStop::before{ border-color: rgba(255,95,122,.40); box-shadow: inset 0 0 18px rgba(255,95,122,.14); }

    .moveLine{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.24);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-weight:950;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      box-shadow: var(--inset);
    }
    .hint{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-weight:900;
      font-size:12px;
      color: rgba(184,208,230,.92);
      opacity:.85;
      user-select:none;
      text-align:right;
    }

    @media (max-width: 1200px){
      .headerInner{ flex-direction:column; align-items:stretch; }
      .title{ text-align:center; }
      .headerActions{ justify-content:center; flex-wrap:wrap; }
    }
    @media (max-width: 980px){
      body{ overflow:auto; }
      .wrap{ width: 96vw; height: auto; min-height: 92vh; }
      .bezel{ position:relative; }
      .hud{ position:relative; inset:auto; margin:16px; }
      .main{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
      }
      .chartCard{ grid-column: 1; grid-row: 1; }
      .telemetryCard{ grid-column: 1; grid-row: 2; }
      .rightPanel{ grid-column: 1; grid-row: 3; }
      .telemetry{ grid-template-columns: 1fr; }
      .telemetry .span2{ grid-column: 1; }
      .lamp{ width: 160px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="bezel">
      <div class="hud">

        <div class="header">
          <div class="headerInner">
            <div class="title">IoT-Based Road Pothole and Crack Detection Robot</div>

            <div class="headerActions">
              <button id="btnStart" class="btn3d">CONNECT</button>
              <button id="btnReset" class="btn3d btnReset">RESET</button>

              <div id="pillConnected" class="pill connected">
                <span class="dot"></span><span>CONNECTED</span>
              </div>

              <div id="pillDisconnected" class="pill disconnected">
                <span class="dot"></span><span>DISCONNECTED</span>
              </div>
            </div>
          </div>
        </div>

        <div class="main">
          <div class="card chartCard">
            <div class="cardHeader">ROAD CHART</div>
            <div class="cardBody">
              <div class="chartArea">
                <div class="legend">
                  <div class="badge bN"><span class="c"></span><span>NORMAL</span></div>
                  <div class="badge bT"><span class="c"></span><span>TILT</span></div>
                  <div class="badge bH"><span class="c"></span><span>HOLE</span></div>
                </div>
                <canvas id="roadChart"></canvas>
              </div>
            </div>
          </div>

          <div class="card telemetryCard">
            <div class="cardBody telemetry">
              <!-- ✅ حسب طلبك: Distance=Location -->
              <div class="row"><div class="k">Location:</div><div id="loc" class="v">-- m</div></div>

              <!-- ✅ Last Pothole = Hole Location -->
              <div class="row"><div class="k">Hole Location:</div><div id="holeLoc" class="v">-- m</div></div>

              <!-- ✅ Last Depth = Drilling depth/cm -->
              <div class="row span2" style="min-height:78px;">
                <div class="k">Drilling depth/cm:</div>
                <div id="depth" class="v big">--</div>
              </div>

              <!-- ✅ Potholes = HoleCount -->
              <div class="row span2" style="min-height:70px;">
                <div class="k">HoleCount:</div>
                <div id="holeCount" class="v" style="font-size:28px;color:var(--orange)">0</div>
              </div>
            </div>
          </div>

          <div class="card rightPanel">
            <div class="cardBody" style="height:100%;">
              <div class="panelBox">

                <div class="lampsBox">
                  <div class="lampsGrid">
                    <div id="lampNormal" class="lamp green"><div class="bulb"></div><div class="lampLabel">NORMAL</div></div>
                    <div id="lampHole" class="lamp red"><div class="bulb"></div><div class="lampLabel">HOLE</div></div>
                    <div id="lampVib" class="lamp yellow"><div class="bulb"></div><div class="lampLabel">VIBRATION</div></div>
                    <div id="lampTilt" class="lamp blue"><div class="bulb"></div><div class="lampLabel">TILTED</div></div>
                  </div>
                </div>

                <div class="controlsBox">
                  <div class="dpad">
                    <div class="ghost"></div>
                    <button class="btn3d btnSmall" data-move="forward">FORWARD</button>
                    <div class="ghost"></div>

                    <button class="btn3d btnSmall" data-move="left">LEFT</button>
                    <button class="btn3d btnSmall btnStop" data-move="stop">STOP</button>
                    <button class="btn3d btnSmall" data-move="right">RIGHT</button>

                    <div class="ghost"></div>
                    <button class="btn3d btnSmall" data-move="reverse">REVERSE</button>
                    <div class="ghost"></div>
                  </div>

                  <div id="moveLine" class="moveLine">MOTOR=STOP</div>
                  <div id="hint" class="hint">LIVE via ThingSpeak • Waiting…</div>
                </div>

              </div>
            </div>
          </div>

        </div><!-- /main -->
      </div><!-- /hud -->
    </div><!-- /bezel -->
  </div><!-- /wrap -->

  <script>
    /* =========================
       ✅ ThingSpeak SETTINGS
       ========================= */
    const TS_CH_ID   = 3231190;
    const TS_READKEY = "QQLHKBK87LP878Z1";

    const TB_ID  = 56199;
    const TB_KEY = "1HYYVXWZHSGZU6I7";

    /* =========================
       UI + Chart
       ========================= */
    const HZ = 5, DT = 1000 / HZ, N = 72, Y_LIMIT = 3.2;
    const STATE = { NORMAL:"NORMAL", HOLE:"HOLE", TILT:"TILT", BOTH:"BOTH" };

    const btnStart = document.getElementById("btnStart");
    const btnReset = document.getElementById("btnReset");
    const pillCon  = document.getElementById("pillConnected");
    const pillDis  = document.getElementById("pillDisconnected");
    const hint     = document.getElementById("hint");

    const elLoc       = document.getElementById("loc");
    const elHoleLoc   = document.getElementById("holeLoc");
    const elDepth     = document.getElementById("depth");
    const elHoleCount = document.getElementById("holeCount");

    const lampNormal = document.getElementById("lampNormal");
    const lampHole   = document.getElementById("lampHole");
    const lampVib    = document.getElementById("lampVib");
    const lampTilt   = document.getElementById("lampTilt");

    const moveLine = document.getElementById("moveLine");

    let polling = false;
    let timer = null;

    const labels = Array.from({length:N}, (_,i)=> i);
    const y = Array.from({length:N}, ()=> 0);
    const stArr = Array.from({length:N}, ()=> STATE.NORMAL);

    const css = getComputedStyle(document.documentElement);
    const C = {
      normal: css.getPropertyValue('--green').trim(),
      tilt:   css.getPropertyValue('--blue').trim(),
      hole:   css.getPropertyValue('--red').trim()
    };

    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
    function setLamp(el,on){ el.classList.toggle("on", !!on); }

    function setConnected(on){
      pillCon.style.opacity = on ? "1" : ".35";
      pillDis.style.opacity = on ? ".35" : "1";
      hint.textContent = on
        ? "LIVE via ThingSpeak • Connected (Channel updates ~16s)"
        : "LIVE via ThingSpeak • Disconnected";
    }

    const glowPlugin = {
      id:"glowPlugin",
      beforeDatasetsDraw(chart){
        const ctx = chart.ctx;
        ctx.save();
        ctx.shadowBlur = 22;
        ctx.shadowColor = "rgba(56,246,255,.22)";
      },
      afterDatasetsDraw(chart){ chart.ctx.restore(); }
    };

    const heatPlugin = {
      id:"heatPlugin",
      beforeDraw(chart){
        const {ctx, chartArea} = chart;
        if(!chartArea) return;

        let lastHole = -1;
        for(let i=stArr.length-1;i>=0;i--){
          if(stArr[i] === STATE.HOLE){ lastHole=i; break; }
        }
        if(lastHole < 0) return;

        const x = chart.scales.x.getPixelForValue(labels[lastHole]);
        const y0 = chartArea.bottom - 4;

        ctx.save();
        const g = ctx.createRadialGradient(x, y0, 10, x, y0, 220);
        g.addColorStop(0, "rgba(255,95,122,.36)");
        g.addColorStop(0.35, "rgba(255,95,122,.18)");
        g.addColorStop(1, "rgba(255,95,122,0)");
        ctx.fillStyle = g;
        ctx.fillRect(chartArea.left, chartArea.top, chartArea.right-chartArea.left, chartArea.bottom-chartArea.top);
        ctx.restore();
      }
    };

    const roadChart = new Chart(document.getElementById("roadChart"), {
      type:"line",
      data:{
        labels,
        datasets:[{
          data:y,
          tension:0.35,
          borderWidth:6,
          pointBorderWidth:1,
          pointBorderColor:"rgba(255,255,255,.50)",
          pointRadius:(c)=>{
            const st = stArr[c.dataIndex];
            if(st === STATE.HOLE) return 8;
            if(st === STATE.TILT) return 6;
            return 0;
          },
          pointBackgroundColor:(c)=>{
            const st = stArr[c.dataIndex];
            if(st === STATE.HOLE) return C.hole;
            if(st === STATE.TILT) return C.tilt;
            return C.normal;
          },
          fill:true,
          backgroundColor:"rgba(56,246,255,.10)",
          segment:{
            borderColor:(seg)=>{
              const st = stArr[seg.p0DataIndex] || STATE.NORMAL;
              if(st === STATE.HOLE) return "rgba(255,95,122,.98)";
              if(st === STATE.TILT) return "rgba(103,191,255,.98)";
              return "rgba(73,255,178,.98)";
            }
          }
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        plugins:{ legend:{display:false}, tooltip:{enabled:false} },
        layout:{ padding:{ top: 10, right: 12, left: 12, bottom: 16 } },
        scales:{
          x:{ grid:{ color:"rgba(255,255,255,.12)" }, ticks:{ color:"rgba(205,230,250,.96)", maxTicksLimit:10, padding:8 } },
          y:{ min:-Y_LIMIT, max:Y_LIMIT, grid:{ color:"rgba(255,255,255,.12)" }, ticks:{ color:"rgba(205,230,250,.96)", padding:8 } }
        }
      },
      plugins:[glowPlugin, heatPlugin]
    });

    /* =========================
       ✅ Read Telemetry (Channel)
       field1 = distanceM  (Location)
       field2 = depthCm
       field3 = holeCount
       field4 = holeLocationM
       field5 = stateCode (0 Normal,1 Tilt,2 Pothole,3 Both)
       ========================= */
    async function getTelemetry(){
      const url = `https://api.thingspeak.com/channels/${TS_CH_ID}/feeds.json?api_key=${TS_READKEY}&results=1`;
      const r = await fetch(url, { cache:"no-store" });
      if(!r.ok) throw new Error("TS read failed");
      const data = await r.json();
      const f = data.feeds && data.feeds[0];
      if(!f) throw new Error("No feed");

      return {
        distanceM: Number(f.field1 || 0),
        depthCm:   Number(f.field2 || 0),
        holeCount: Number(f.field3 || 0),
        holeLocM:  Number(f.field4 || 0),
        stateCode: Number(f.field5 || 0),
        updatedAt: f.created_at || ""
      };
    }

    function codeToState(code){
      if(code === 1) return "TILT";
      if(code === 2) return "HOLE";
      if(code === 3) return "BOTH";
      return "NORMAL";
    }

    function applyTelemetry(t){
      elLoc.textContent     = `${t.distanceM.toFixed(2)} m`;
      elHoleLoc.textContent = `${t.holeLocM.toFixed(2)} m`;
      elDepth.textContent   = (t.depthCm>0) ? t.depthCm.toFixed(1) : "--";
      elHoleCount.textContent = String(t.holeCount);

      const st = codeToState(t.stateCode);

      setLamp(lampNormal, st === "NORMAL");
      setLamp(lampTilt,   st === "TILT");
      setLamp(lampHole,   st === "HOLE");
      setLamp(lampVib,    st === "HOLE" || st === "BOTH");

      // Chart mapping:
      // Normal -> 0
      // Tilt   -> +2.0
      // Hole   -> -2.6
      // Both   -> -1.6
      const v = (st==="HOLE")?-2.6:(st==="TILT")?2.0:(st==="BOTH")?-1.6:0.0;

      y.push(clamp(v, -Y_LIMIT, Y_LIMIT));
      stArr.push(st==="HOLE" ? STATE.HOLE : (st==="TILT" ? STATE.TILT : STATE.NORMAL));
      labels.push(labels[labels.length-1]+1);

      y.shift(); stArr.shift(); labels.shift();
      roadChart.update("none");
    }

    /* =========================
       ✅ Send Command to TalkBack queue
       We'll POST a new command_string
       ========================= */
    async function tbAddCommand(cmd){
      // POST https://api.thingspeak.com/talkbacks/<id>/commands.json
      const url = `https://api.thingspeak.com/talkbacks/${TB_ID}/commands.json`;
      const body = new URLSearchParams({ api_key: TB_KEY, command_string: cmd });

      const r = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      // ThingSpeak may return 200/201 with JSON
      if(!r.ok) throw new Error("TalkBack post failed");
      return true;
    }

    async function poll(){
      try{
        const t = await getTelemetry();
        setConnected(true);
        applyTelemetry(t);
      }catch(e){
        setConnected(false);
      }
    }

    function startPolling(){
      if(polling) return;
      polling = true;
      btnStart.textContent = "DISCONNECT";
      poll();
      timer = setInterval(poll, DT);
    }

    function stopPolling(){
      polling = false;
      btnStart.textContent = "CONNECT";
      if(timer){ clearInterval(timer); timer = null; }
      setConnected(false);
    }

    async function doReset(){
      // reset UI instantly
      elLoc.textContent = "-- m";
      elHoleLoc.textContent = "-- m";
      elDepth.textContent = "--";
      elHoleCount.textContent = "0";
      setLamp(lampNormal, true);
      setLamp(lampHole, false);
      setLamp(lampTilt, false);
      setLamp(lampVib, false);

      for(let i=0;i<N;i++){
        y[i]=0; labels[i]=i; stArr[i]=STATE.NORMAL;
      }
      roadChart.update("none");
      moveLine.textContent = "MOTOR=STOP";
      hint.textContent = "LIVE via ThingSpeak • Reset sent…";

      // send reset to Arduino
      try{
        await tbAddCommand("RESET");
      }catch(e){}
    }

    btnStart.addEventListener("click", ()=> polling ? stopPolling() : startPolling());
    btnReset.addEventListener("click", doReset);

    document.querySelectorAll("[data-move]").forEach(b=>{
      b.addEventListener("click", async ()=>{
        const cmd = b.getAttribute("data-move");

        // UI label
        if(cmd === "stop") moveLine.textContent = "MOTOR=STOP";
        else moveLine.textContent = `MOTOR=${cmd.toUpperCase()}`;

        // Map UI to your TalkBack command strings
        let tbCmd = "";
        if(cmd === "forward") tbCmd = "CMD:F";
        else if(cmd === "reverse") tbCmd = "CMD:R";
        else if(cmd === "stop") tbCmd = "CMD:S";
        else if(cmd === "left") tbCmd = "STEER:L";
        else if(cmd === "right") tbCmd = "STEER:R";

        try{
          await tbAddCommand(tbCmd);
          hint.textContent = `COMMAND SENT • ${tbCmd}`;
        }catch(e){
          hint.textContent = `COMMAND FAILED • ${tbCmd}`;
        }
      });
    });

    // default
    stopPolling();
  </script>
</body>
</html>
